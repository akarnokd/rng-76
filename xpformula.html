<html lang="en">
    <head>
        <title>Program to find the XP formula</title>
        <style>
            * {
                font-family: sans-serif;
                font-size: 20px;
            }
            table {
                border-collapse: collapse;
            }
            td {
                border: 1px solid black;
                padding: 3px;
                text-align: right;
            }
        </style>
    </head>
    <body>
        <h1>Program to find the XP formula (0.01)</h1>
        <button onclick='calc();'>Calc</button>
        <br>
        <span id='result'></span>
        <table id='tbl'>
            <tr>
                <td>Base XP</td>
                <td>Int</td>
                <td>Team</td>
                <td>Rest</td>
                <td>Relish</td>
                <td>Inspire</td>
                <td>Lunch</td>
                <td>Double</td>
                <td>Ingame</td>
                <td>Calc</td>
                <td>Error</td>
            </tr>
        </table>
        <script>
            var data = [
                entry(48, 102.8, 11, 2, 5, 10, 15, 0, 100, 372),
                entry(48, 102.8, 11, 2, 5, 10, 10, 0, 100, 356),
                entry(48, 102.8, 11, 2, 5, 10, 5, 0, 100, 344),
                entry(48, 102.8, 11, 2, 5, 10, 0, 0, 100, 328),
                entry(48, 102.8, 11, 4, 0, 0, 15, 0, 100, 340),
                entry(48, 102.8, 11, 4, 0, 6, 15, 0, 100, 356),
                entry(48, 102.8, 11, 3, 0, 6, 15, 0, 100, 352),
                entry(48, 102.8, 11, 3, 0, 6, 10, 0, 100, 336),
                entry(48, 102.8, 11, 3, 0, 6, 5, 0, 100, 320),
                entry(48, 102.8, 11, 2, 0, 6, 15, 0, 100, 344),
                entry(48, 102.8, 9, 2, 0, 6, 15, 0, 100, 328),
                entry(48, 102.8, 11, 3, 0, 2, 15, 0, 100, 340),
                entry(48, 102.8, 11, 3, 0, 4, 15, 0, 100, 344),
                entry(48, 102.8, 11, 3, 0, 0, 15, 0, 100, 332),
                entry(48, 102.8, 9, 3, 0, 0, 15, 0, 100, 320),
                entry(48, 102.8, 11, 1, 0, 0, 0, 0, 100, 276),
                entry(48, 102.8, 9, 1, 0, 0, 0, 0, 100, 264),
                entry(48, 102.8, 9, 0, 0, 0, 0, 0, 100, 260),
                entry(48, 102.8, 11, 0, 0, 0, 0, 0, 100, 272),
                entry(48, 102.8, 11, 3, 50, 0, 15, 0, 100, 500),

                entry(68, 140.2, 11, 2, 0, 10, 15, 0, 100, 488),
                entry(68, 140.2, 11, 2, 5, 10, 15, 0, 100, 512),
                entry(68, 140.2, 11, 2, 5, 10, 10, 0, 100, 492),
                entry(68, 140.2, 11, 2, 5, 10, 5, 0, 100, 468),
                entry(68, 140.2, 11, 4, 0, 6, 15, 0, 100, 492),
                entry(68, 140.2, 11, 3, 0, 6, 15, 0, 100, 480),
                entry(68, 140.2, 11, 3, 0, 6, 10, 0, 100, 460),
                entry(68, 140.2, 11, 3, 0, 6, 5, 0, 100, 440),
                entry(68, 140.2, 11, 2, 0, 6, 15, 0, 100, 472),
                entry(68, 140.2, 9, 2, 0, 6, 15, 0, 100, 452),
                entry(68, 140.2, 11, 3, 0, 2, 15, 0, 100, 464),
                entry(68, 140.2, 11, 3, 0, 4, 15, 0, 100, 472),
                entry(68, 140.2, 9, 3, 0, 0, 15, 0, 100, 436),
                entry(68, 140.2, 11, 2, 0, 0, 15, 0, 100, 448),
                entry(68, 140.2, 11, 3, 0, 0, 15, 0, 100, 456),
                entry(68, 140.2, 11, 4, 0, 0, 15, 0, 100, 468),
                entry(68, 140.2, 11, 1, 0, 0, 0, 0, 100, 380),
                entry(68, 140.2, 11, 0, 0, 0, 0, 0, 100, 372),
                entry(68, 140.2, 9, 0, 0, 0, 0, 0, 100, 356),
                entry(68, 140.2, 9, 1, 0, 0, 0, 0, 100, 364),
                entry(68, 140.2, 13, 0, 0, 0, 0, 0, 100, 388),
                entry(68, 140.2, 16, 0, 0, 0, 0, 0, 100, 416),
                entry(68, 140.2, 18, 0, 0, 0, 0, 0, 100, 432),
                entry(68, 140.2, 19, 0, 0, 0, 0, 0, 100, 440),
                entry(68, 140.2, 19, 1, 0, 0, 0, 0, 100, 448),
                entry(68, 140.2, 11, 3, 0, 0, 15, 50, 100, 684),
                entry(68, 140.2, 11, 4, 5, 10, 15, 50, 100, 800),
                entry(68, 140.2, 11, 4, 5, 10, 15, 0, 100, 532),
            ];

            function entry(level, base, int, team, rest, relish, inspire, lunch, dbl, xp) {
                return {
                    level: level,
                    base: base,
                    int: int * 0.03,
                    team: team * 0.03,
                    rest: rest * 0.01,
                    relish: relish * 0.01,
                    inspire: inspire * 0.01,
                    lunch: lunch * 0.01,
                    dbl: dbl * 0.01,
                    xp: xp
                };
            }

            var properties = [
                "int", "team", "rest", "relish", "inspire", "lunch", "dbl"
            ];

            // returns List<List<List<T>>>
            function partition(ori, m) {
                if (ori.length < m || m < 1) {
                    return [];
                }
                if (m == 1) {
                    return [ [ ori.slice() ] ];
                }

                var result = [];

                var prev1 = partition(ori.slice(0, ori.length - 1), m);

                for (var i = 0; i < prev1.length; i++) {
                    for (var j = 0; j < prev1[i].length; j++) {
                        var lst = [];
                        for (var inner of prev1[i]) {
                            lst.push(inner.slice());
                        }
                        lst[j].push(ori[ori.length - 1]);
                        result.push(lst);
                    }
                }

                var set = [ ori[ori.length - 1] ];

                var prev2 = partition(ori.slice(0, ori.length - 1), m - 1);
                for (var i = 0; i < prev2.length; i++) {
                    var lst = prev2[i].slice();
                    lst.push(set);
                    result.push(lst);
                }

                return result;
            }

            function toStr(list) {
                var txt = "[";
                var n = 0;
                for (var e of list) {
                    if (n != 0) {
                        txt += ", ";
                    }
                    if (Array.isArray(e)) {
                        txt += toStr(e);
                    } else {
                        txt += e;
                    }
                    n++;
                }
                txt += "]";
                return txt;
            }

            var roundName = "Floor";
            function round(val) {
                return Math.floor(val);
            }

            function calculateEntry(entry, partition, rounding) {
                var product = (rounding & 1) == 0 ? entry.base : round(entry.base) ;

                var m = 1;
                for (var p of partition) {
                    var sum = 1;
                    for (var q of p) {
                        sum += entry[q];
                    }
                    if ((rounding & (1 << m)) != 0) {
                        product = round(product * sum);
                    } else {
                        product *= sum;
                    }
                    m++;
                }

                return product;
            }

            function toFormula(partition, rounding) {
                var txt;
                
                if ((rounding & 1) == 0) {
                    txt = "step1 = base<br>";
                } else {
                    txt = "step1 = " + roundName + "(base)<br>";
                }

                var n = 1;
                for (var p of partition) {

                    txt += "step" + (n + 1) + " = "

                    var doRounding = (rounding & (1 << n)) != 0;
                    if (doRounding) {
                        txt += roundName + "("
                    }

                    txt += "step" + (n) + " * (1 ";
                    for (var q of p) {
                        txt += " + " + q;
                    }
                    txt += ")"

                    if (doRounding) {
                        txt += ")"
                    }
                    txt += "<br>";
                    n++;
                }
                return txt;
            }

            function errorFunc(expected, actual) {
                return (expected - actual) * (expected - actual);
            }

            function calc() {
                var res = document.getElementById("result");
                res.innerHTML = "";

                /*
                for (var i = 1; i <= properties.length; i++) {
                    var span = document.createElement("span");
                    var txt = toStr(partition(properties, i));

                    span.innerText = txt;
                    res.appendChild(span);
                    res.append(document.createElement("br"));
                }
                */

                var allPartitions = [];
                for (var i = 1; i <= properties.length; i++) {
                    for (var p of partition(properties, i)) {

                        var rm = 1 << (p.length + 1);
                        for (var r = 0; r < rm; r++) {
                            var ra = r;
                            var errorSquare = 0;
                            for (var d of data) {
                                var n = calculateEntry(d, p, ra);
                                var e = d.xp;
                                errorSquare += errorFunc(e, n);
                            }

                            allPartitions.push({
                                partition: p,
                                error: errorSquare,
                                round: ra
                            });
                        }
                    }
                }

                var smallestP = undefined;
                var smallestErr = undefined;
                var smallestR = undefined;

                for (var a of allPartitions) {
                    if (smallestErr === undefined || smallestErr > a.error) {
                        smallestErr = a.error;
                        smallestP = a.partition;
                        smallestR = a.round;
                    }
                }

                var span = document.createElement("span");
                span.innerText = toStr(smallestP);
                res.appendChild(span);
                res.append(document.createElement("br"));

                span = document.createElement("span");
                span.innerHTML = toFormula(smallestP, smallestR);
                res.appendChild(span);
                res.append(document.createElement("br"));

                span = document.createElement("span");
                span.innerText = "Cumulative error: " + smallestErr.toFixed(3);
                res.appendChild(span);
                
                res.append(document.createElement("br"));

                var tbl = document.getElementById("tbl")

                for (var i = tbl.rows.length - 1; i > 0; i--) {
                    tbl.deleteRow(i);
                }

                for (var d of data) {
                    var rw = tbl.insertRow(tbl.rows.length);

                    var cll = rw.insertCell(rw.cells.length);
                    cll.innerText = "" + d.base;

                    cll = rw.insertCell(rw.cells.length);
                    cll.innerText = "" + (d.int * 100 / 3).toFixed(0);

                    cll = rw.insertCell(rw.cells.length);
                    cll.innerText = "" + (d.team * 100 / 3).toFixed(0);

                    cll = rw.insertCell(rw.cells.length);
                    cll.innerText = "" + (d.rest * 100).toFixed(0);

                    cll = rw.insertCell(rw.cells.length);
                    cll.innerText = "" + (d.relish * 100).toFixed(0);

                    cll = rw.insertCell(rw.cells.length);
                    cll.innerText = "" + (d.inspire * 100).toFixed(0);

                    cll = rw.insertCell(rw.cells.length);
                    cll.innerText = "" + (d.lunch * 100).toFixed(0);

                    cll = rw.insertCell(rw.cells.length);
                    cll.innerText = "" + (d.dbl * 100).toFixed(0);

                    cll = rw.insertCell(rw.cells.length);
                    cll.innerText = "" + (d.xp).toFixed(0);

                    var n = calculateEntry(d, smallestP, smallestR);

                    cll = rw.insertCell(rw.cells.length);
                    cll.innerText = "" + (n).toFixed(1);

                    cll = rw.insertCell(rw.cells.length);
                    cll.innerText = "" + (n - d.xp).toFixed(1);
                }
            }
        </script>
    </body>
</html>