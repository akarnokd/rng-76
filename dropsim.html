<html>
    <head>
        <title>Fallout 76 Purveyor</title>
        <style>
            * {
                font-family: sans-serif;
                font-size: 20px;
            }
            td {
                padding: 1px;
            }
            
            table.infoTable {
               border: 1px solid black;
               border-collapse: collapse;
            }
            table.infoTable td {
               border: 1px solid black;
               padding: 4px; 
            }

            .setupInput {
                background-color: lightyellow;
                text-align: right;
            }
        </style>
        <meta name="keywords" content="Fallout,Fallout 76,RNG,Random number generator,loot,chance">
    </head>
    <body style="height: 90%">
        <center>
            <span style="font-size: 36px; font-weight: bold;">Fallout 76 Loot Drop Simulation (v0.1)</span>
            <br/><br/>
            Number of tries: <input type="number" min="1" id="txtTries" value="10000" class="setupInput">&nbsp;<button id="btnRun">Run</button>
            <br/>
            <table>
                <tr>
                    <td style="width: 250px; text-align: right;">Progress:</td>
                    <td style="width: 1002px;">
                        <div style="width: 1000px; height: 20px; background-color: #CCCCCC">
                            <div id="txtProgress" style="background-color: blue; height: 20px; width: 0%"></div>
                        </div>
                    </td>
                    <td id="txtProgressText" style="width: 250px; text-align: left;">0.000%</td>
                </tr>
            </table>
            <br/>
            <br/>
            <table class="infoTable">
                <tr>
                    <td id="tabSetupBtn" style="padding: 4px; cursor: pointer; background-color: lightgreen;">
                        Setup
                    </td>
                    <td id="tabStarsBtn" style="padding: 4px; cursor: pointer;">
                        Star drop stats
                    </td>
                    <td id="tabEffectsBtn" style="padding: 4px; cursor: pointer;">
                            Effect drop stats
                    </td>
                    <td id="tabArmorBtn" style="padding: 4px; cursor: pointer;">
                            Armor drop stats
                    </td>
                    <td id="tabMeleeBtn" style="padding: 4px; cursor: pointer;">
                        Melee drop stats
                    </td>
                    <td id="tabRangedBtn" style="padding: 4px; cursor: pointer;">
                        Ranged drop stats
                    </td>
                    <td id="tabItemBtn" style="padding: 4px; cursor: pointer;">
                        Item effect stats
                    </td>
                    <td id="tabStreaksBtn" style="padding: 4px; cursor: pointer; display: none;">
                        Streak stats
                    </td>
                </tr>
            </table>
            <div id="tabSetup" style="display: block; border: 1px solid black; border-collapse: collapse;">
                <br>
                <center><span style="font-size: 26px; font-weight: bold;">Simulation setup</span></center>
                <br/>
                <br/>
                <b>Legendary enemy and drop chances matrix</b>
                <table class="infoTable">
                    <tr>
                        <td>Enemy star level</td>
                        <td>Enemy occurrence chance</td>
                        <td>1* drop chance</td>
                        <td>2* drop chance</td>
                        <td>3* drop chance</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">1</td>
                        <td><input type="number" id="enemy1chance" value="75" min="0" max="100" class="setupInput"> %</td>
                        <td>100 %</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">2</td>
                        <td><input type="number" id="enemy2chance" value="5" min="0" max="100" class="setupInput"> %</td>
                        <td><input type="number" id="enemy2drop1chance" value="55" min="0" max="100" class="setupInput"> %</td>
                        <td><input type="number" id="enemy2drop2chance" value="45" min="0" max="100" class="setupInput"> %</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">3</td>
                        <td><input type="number" id="enemy3chance" value="20" min="0" max="100" class="setupInput"> %</td>
                        <td><input type="number" id="enemy3drop1chance" value="40" min="0" max="100" class="setupInput"> %</td>
                        <td><input type="number" id="enemy3drop2chance" value="35" min="0" max="100" class="setupInput"> %</td>
                        <td><input type="number" id="enemy3drop3chance" value="25" min="0" max="100" class="setupInput"> %</td>
                    </tr>
                    <tr>
                        <td>Presets</td>
                        <td colspan="4">
                            <button id="presetDefault">Default</button>&nbsp;
                            <button id="presetMaxLevel">Max star only</button>&nbsp;
                        </td>
                    </tr>
                </table>
                <br/>
                <br/>
                <b>Disallowed drop handling mode:</b><br>
                <table style="border: 1px solid black; border-collapse: collapse;">
                    <tr>
                        <td>
                            <input type="radio" name="disallowedDrop" id="disallowedDropPrefilter" value="Prefilter" checked="checked"><label for="disallowedDropPrefilter"> Filter out items/effects upfront.</label>
                        </td>
                        <td>
                            (Example: If RNG rolls a 2* Broadsider, the Explosive effect will be removed from the possible rolls for the major effect.)
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="radio" name="disallowedDrop" id="disallowedDropRetryEffect" value="Retry Effect" disabled="disabled" title="Not implemented yet."><label for="disallowedDropRetryEffect" title="Not implemented yet."> Keep retrying the effect.</label>
                        </td>
                        <td>
                            (Example: If RNG rolls a 2* Broadsider and RNG rolls for Explosive, the major effect is re-rolled until it gives something else.)
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="radio" name="disallowedDrop" id="disallowedDropRetryItem" value="Retry Item" disabled="disabled" title="Not implemented yet."><label for="disallowedDropRetryItem" title="Not implemented yet."> Keep retrying the item.</label>
                        </td>
                        <td>
                            (Example: If RNG rolls a 2* Broadsider and RNG rolls for Explosive, the entire drop is re-rolled until it gives a valid item+effect combo.)
                        </td>
                    </tr>
                </table>
                <br>
                <br>
                <b>Wood armor can roll as multi-star:</b><br>
                <table style="border: 1px solid black; border-collapse: collapse;">
                    <tr>
                        <td>
                            <input type="radio" name="woodMultistar" id="woodMultistarYes" value="Yes"><label for="woodMultistarYes"> Yes</label>
                        </td>
                        <td>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="radio" name="woodMultistar" id="woodMultistarNo" value="No" checked="checked"><label for="woodMultistarNo"> No</label>
                        </td>
                        <td>
                            (Not sure, but up until Patch 10.5, Wood armor still can't drop as 2-3* from legendaries, only from the Purveyor.)
                        </td>
                    </tr>
                </table>
                <br>
                <br>
                <b>Assaultron Head can roll as multi-star:</b><br>
                <table style="border: 1px solid black; border-collapse: collapse;">
                    <tr>
                        <td>
                            <input type="radio" name="assaultronMultistar" id="assaultronMultistarYes" value="Yes"><label for="assaultronMultistarYes"> Yes</label>
                        </td>
                        <td>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="radio" name="assaultronMultistar" id="assaultronMultistarNo" value="No" checked="checked"><label for="assaultronMultistarNo"> No</label>
                        </td>
                        <td>
                            (Not sure, but up until Patch 10.5, Assaultron Head still can't drop as 2-3* from legendaries, only from the Purveyor.)
                        </td>
                    </tr>
                </table>
                <br>
                <br>
                <b>Energy weapons can drop as Explosive:</b><br>
                <table style="border: 1px solid black; border-collapse: collapse;">
                    <tr>
                        <td>
                            <input type="radio" name="energyExplosive" id="energyExplosiveYes" value="Yes"><label for="energyExplosiveYes"> Yes</label>
                        </td>
                        <td>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="radio" name="energyExplosive" id="energyExplosiveNo" value="No" checked="checked"><label for="energyExplosiveNo"> No</label>
                        </td>
                        <td>
                            (One of the recent patches disabled this type of drop until they figure out what to do)
                        </td>
                    </tr>
                </table>
                <br>
                <br>
                <b>Energy weapons can drop as Anti-armor:</b><br>
                <table style="border: 1px solid black; border-collapse: collapse;">
                    <tr>
                        <td>
                            <input type="radio" name="energyAntiArmor" id="energyAntiArmorYes" value="Yes" checked="checked"><label for="energyAntiArmorYes"> Yes</label>
                        </td>
                        <td>
                            (Currently, the Anti-armor legendary effect does not reduce any resistance on enemies; a longstanding incomplete design remnant from Fallout 4.)
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="radio" name="energyAntiArmor" id="energyAntiArmorNo" value="No"><label for="energyAntiArmorNo"> No</label>
                        </td>
                        <td>
                        </td>
                    </tr>
                </table>
                <br>
                <br>
                <b>Progress bar update frequency:</b><br>
                Every <input type="number" id="progressUpdateItems" value="100" min="1" class="setupInput"> drops.

                <br>&nbsp;
            </div>
            <div id="tabStars" style="display: none; border: 1px solid black; border-collapse: collapse;">
                <br>
                <center><span style="font-size: 26px; font-weight: bold;">Star drop statistics</span></center>
                <br>
                <br>
                <table class="infoTable">
                    <tr style='font-weight: bold;'>
                        <td rowspan="2">Enemy star</td>
                        <td colspan="3">0 star drops</td>
                        <td colspan="3">1 star drops</td>
                        <td colspan="3">2 star drops</td>
                        <td colspan="3">3 star drops</td>
                        <td colspan="2">Total</td>
                    </tr>
                    <tr style='font-weight: bold;'>
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>% total</td>
                    </tr>
                    <tr style="border-top: 2px solid black;">
                        <td>1</td>
                        <td style='text-align: right' id='statenemy1drop0count'>0</td>
                        <td style='text-align: right' id='statenemy1drop0percent'>0</td>
                        <td style='text-align: right' id='statenemy1drop0percenttotal'>0</td>
                        <td style='text-align: right' id='statenemy1drop1count'>0</td>
                        <td style='text-align: right' id='statenemy1drop1percent'>0</td>
                        <td style='text-align: right' id='statenemy1drop1percenttotal'>0</td>
                        <td colspan='6' style="text-align: center;">N/A</td>
                        <td style='text-align: right' id='statenemy1count'>0</td>
                        <td style='text-align: right' id='statenemy1percent'>0</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td style='text-align: right' id='statenemy2drop0count'>0</td>
                        <td style='text-align: right' id='statenemy2drop0percent'>0</td>
                        <td style='text-align: right' id='statenemy2drop0percenttotal'>0</td>
                        <td style='text-align: right' id='statenemy2drop1count'>0</td>
                        <td style='text-align: right' id='statenemy2drop1percent'>0</td>
                        <td style='text-align: right' id='statenemy2drop1percenttotal'>0</td>
                        <td style='text-align: right' id='statenemy2drop2count'>0</td>
                        <td style='text-align: right' id='statenemy2drop2percent'>0</td>
                        <td style='text-align: right' id='statenemy2drop2percenttotal'>0</td>
                        <td colspan='3' style="text-align: center;">N/A</td>
                        <td style='text-align: right' id='statenemy2count'>0</td>
                        <td style='text-align: right' id='statenemy2percent'>0</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td style='text-align: right' id='statenemy3drop0count'>0</td>
                        <td style='text-align: right' id='statenemy3drop0percent'>0</td>
                        <td style='text-align: right' id='statenemy3drop0percenttotal'>0</td>
                        <td style='text-align: right' id='statenemy3drop1count'>0</td>
                        <td style='text-align: right' id='statenemy3drop1percent'>0</td>
                        <td style='text-align: right' id='statenemy3drop1percenttotal'>0</td>
                        <td style='text-align: right' id='statenemy3drop2count'>0</td>
                        <td style='text-align: right' id='statenemy3drop2percent'>0</td>
                        <td style='text-align: right' id='statenemy3drop2percenttotal'>0</td>
                        <td style='text-align: right' id='statenemy3drop3count'>0</td>
                        <td style='text-align: right' id='statenemy3drop3percent'>0</td>
                        <td style='text-align: right' id='statenemy3drop3percenttotal'>0</td>
                        <td style='text-align: right' id='statenemy3count'>0</td>
                        <td style='text-align: right' id='statenemy3percent'>0</td>
                    </tr>
                    <tr style="border-top: 2px solid black;">
                        <td>Total</td>
                        <td style='text-align: right' id='statdrop0count'>0</td>
                        <td style='text-align: right' id='statdrop0percent' colspan="2">0</td>
                        <td style='text-align: right' id='statdrop1count'>0</td>
                        <td style='text-align: right' id='statdrop1percent' colspan="2">0</td>
                        <td style='text-align: right' id='statdrop2count'>0</td>
                        <td style='text-align: right' id='statdrop2percent' colspan="2">0</td>
                        <td style='text-align: right' id='statdrop3count'>0</td>
                        <td style='text-align: right' id='statdrop3percent' colspan="2">0</td>
                        <td style='text-align: right' id='statcount'>0</td>
                        <td style='text-align: right' id='statpercent'>100</td>
                    </tr>
                </table>
                <br>&nbsp;
            </div>
            <div id="tabEffects" style="display: none; border: 1px solid black; border-collapse: collapse;">
                <br>
                <center>
                    <span style="font-size: 26px; font-weight: bold;">Effect drop statistics</span>
                    &nbsp;&nbsp;<button id="effectsSortByPercent">Re-sort by percent</button>
                    &nbsp;&nbsp;<button id="effectsSortByName">Re-sort by name</button>
                </center>
                <table width='100%'>
                    <tr>
                        <td style='text-align: center;' width='33%' valign='top'>
                            <b>Armor</b><br/>
                            <table class='infoTable' id='statArmorPrefix'>
                                <tr style='font-weight: bold;'>
                                    <td>Prefix</td>
                                    <td style="text-align: right" id="statArmorPrefixCount">0</td>
                                    <td style="text-align: right" id="statArmorPrefixPercent">0</td>
                                </tr>
                                <tr style='font-weight: bold;'><td>Name</td><td>Count</td><td>Percent</td></tr>
                            </table>
                            <br>
                            <table class='infoTable' id='statArmorMajor'>
                                <tr style='font-weight: bold;'>
                                    <td>Major</td>
                                    <td style="text-align: right" id="statArmorMajorCount">0</td>
                                    <td style="text-align: right" id="statArmorMajorPercent">0</td>
                                </tr>
                                <tr style='font-weight: bold;'><td>Name</td><td>Count</td><td>Percent</td></tr>
                            </table>
                            <br>
                            <table class='infoTable' id='statArmorMinor'>
                                <tr style='font-weight: bold;'>
                                    <td>Minor</td>
                                    <td style="text-align: right" id="statArmorMinorCount">0</td>
                                    <td style="text-align: right" id="statArmorMinorPercent">0</td>
                                </tr>
                                <tr style='font-weight: bold;'><td>Name</td><td>Count</td><td>Percent</td></tr>
                            </table>
                        </td>
                        <td style='text-align: center' width='33%' valign='top'>
                            <b>Melee</b>
                            <table class='infoTable' id='statMeleePrefix'>
                                <tr style='font-weight: bold;'>
                                    <td>Prefix</td>
                                    <td style="text-align: right" id="statMeleePrefixCount">0</td>
                                    <td style="text-align: right" id="statMeleePrefixPercent">0</td>
                                </tr>
                                <tr style='font-weight: bold;'><td>Name</td><td>Count</td><td>Percent</td></tr>
                            </table>
                            <br>
                            <table class='infoTable' id='statMeleeMajor'>
                                <tr style='font-weight: bold;'>
                                    <td>Major</td>
                                    <td style="text-align: right" id="statMeleeMajorCount">0</td>
                                    <td style="text-align: right" id="statMeleeMajorPercent">0</td>
                                </tr>
                                <tr style='font-weight: bold;'><td>Name</td><td>Count</td><td>Percent</td></tr>
                            </table>
                            <br>
                            <table class='infoTable' id='statMeleeMinor'>
                                <tr style='font-weight: bold;'>
                                    <td>Minor</td>
                                    <td style="text-align: right" id="statMeleeMinorCount">0</td>
                                    <td style="text-align: right" id="statMeleeMinorPercent">0</td>
                                </tr>
                                <tr><td>Name</td><td>Count</td><td>Percent</td></tr>
                            </table>
                        </td>
                        <td style='text-align: center' width='33%' valign='top'>
                            <b>Ranged</b>
                            <table class='infoTable' id='statRangedPrefix'>
                                <tr style='font-weight: bold;'>
                                    <td>Prefix</td>
                                    <td style="text-align: right" id="statRangedPrefixCount">0</td>
                                    <td style="text-align: right" id="statRangedPrefixPercent">0</td>
                                </tr>
                                <tr style='font-weight: bold;'><td>Name</td><td>Count</td><td>Percent</td></tr>
                            </table>
                            <br>
                            <table class='infoTable' id='statRangedMajor'>
                                <tr style='font-weight: bold;'>
                                    <td>Major</td>
                                    <td style="text-align: right" id="statRangedMajorCount">0</td>
                                    <td style="text-align: right" id="statRangedMajorPercent">0</td>
                                </tr>
                                <tr style='font-weight: bold;'><td>Name</td><td>Count</td><td>Percent</td></tr>
                            </table>
                            <br>
                            <table class='infoTable' id='statRangedMinor'>
                                <tr style='font-weight: bold;'>
                                    <td>Minor</td>
                                    <td style="text-align: right" id="statRangedMinorCount">0</td>
                                    <td style="text-align: right" id="statRangedMinorPercent">0</td>
                                </tr>
                                <tr style='font-weight: bold;'><td>Name</td><td>Count</td><td>Percent</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>
                <br>&nbsp;
            </div>
            <div id="tabArmor" style="display: none; border: 1px solid black; border-collapse: collapse;">
                <br>
                <center><span style="font-size: 26px; font-weight: bold;">Armor drop statistics</span>
                    &nbsp;&nbsp;<button id="armorsSortByPercent">Re-sort by percent</button>
                    &nbsp;&nbsp;<button id="armorsSortByName">Re-sort by name</button>
                </center>
                <br>
                <br>
                <table class='infoTable' id='statArmorItems'>
                    <tr style="font-weight: bold;">
                        <td rowspan="2" id="statArmorItemsOverview">Name</td>
                        <td colspan="3">1* drop</td>
                        <td colspan="3">2* drop</td>
                        <td colspan="3">3* drop</td>
                        <td colspan="2">Total</td>
                    </tr>
                    <tr style="font-weight: bold;">
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>%</td>
                    </tr>
                </table>
                <br>&nbsp;
            </div>
            <div id="tabMelee" style="display: none; border: 1px solid black; border-collapse: collapse;">
                <br>
                <center><span style="font-size: 26px; font-weight: bold;">Melee drop statistics</span>
                    &nbsp;&nbsp;<button id="meleesSortByPercent">Re-sort by percent</button>
                    &nbsp;&nbsp;<button id="meleesSortByName">Re-sort by name</button>
                </center>
                <br>
                <br>
                <table class='infoTable' id='statMeleeItems'>
                    <tr style="font-weight: bold;">
                        <td rowspan="2" id="statMeleeItemsOverview">Name</td>
                        <td colspan="3">1* drop</td>
                        <td colspan="3">2* drop</td>
                        <td colspan="3">3* drop</td>
                        <td colspan="2">Total</td>
                    </tr>
                    <tr style="font-weight: bold;">
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>%</td>
                    </tr>
                </table>
                <br>&nbsp;
            </div>
            <div id="tabRanged" style="display: none; border: 1px solid black; border-collapse: collapse;">
                <br>
                <center><span style="font-size: 26px; font-weight: bold;">Ranged drop statistics</span>
                    &nbsp;&nbsp;<button id="rangedsSortByPercent">Re-sort by percent</button>
                    &nbsp;&nbsp;<button id="rangedsSortByName">Re-sort by name</button>
                </center>
                <br>
                <br>
                <table class='infoTable' id='statRangedItems'>
                    <tr style="font-weight: bold;">
                        <td rowspan="2" id="statRangedItemsOverview">Name</td>
                        <td colspan="3">1* drop</td>
                        <td colspan="3">2* drop</td>
                        <td colspan="3">3* drop</td>
                        <td colspan="2">Total</td>
                    </tr>
                    <tr style="font-weight: bold;">
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>% row</td>
                        <td>% total</td>
                        <td>Count</td>
                        <td>%</td>
                    </tr>
                </table>
                <br>&nbsp;
            </div>
            <div id="tabItem" style="display: none; border: 1px solid black; border-collapse: collapse;">
                <br>
                <center><span style="font-size: 26px; font-weight: bold;">Item effect statistics</span></center>
                <br>
                <br>
                Select an item: 
                <select id="selItem">
                    <option value="">-</option>
                </select>
                &nbsp;&nbsp;(<span id="selCount">0</span>)
                <br>
                <br>
                <input type="radio" name="selItemSort" id="selItemSortByName" value="Name" checked="checked"><label for="selItemSortByName"> Sort by effect name</label>
                &nbsp;&nbsp;&nbsp;<input type="radio" name="selItemSort" id="selItemSortByCount" value="Count"><label for="selItemSortByCount"> Sort by count</label>
                <br>
                <br>
                <table class='infoTable' id="selItemTable">
                    <tr style='font-weight: bold;'>
                        <td>Prefix</td>
                        <td>Major</td>
                        <td>Minor</td>
                        <td>Count</td>
                        <td>% item</td>
                        <td>% total</td>
                    </tr>
                    <tr style='font-weight: bold;'>
                        <td colspan="3">Total</td>
                        <td id='selItemTotal' style="text-align: right;">0</td>
                        <td id='selItemTotalPercent' colspan="2" style="text-align: right;">0.000%</td>
                    </tr>
                </table>
                <br>&nbsp;
            </div>
            <div id="tabStreaks" style="display: none; border: 1px solid black; border-collapse: collapse;">
                <br>
                <center><span style="font-size: 26px; font-weight: bold;">Streaks statistics</span></center>
                <br>&nbsp;
            </div>
        </center>

        <script>

            var lootpool = [];
            var effectpool = new Map();
            var effectpoolLookup = new Map()

            // helper functions

            function addItem(category, name, tags) {
                lootpool.push({ category: category, name: name, tags: tags });
            }

            function addEffect(category, level, name, description) {
                var levelpool = effectpool.get(category);
                if (levelpool == null) {
                    levelpool = new Map();
                    effectpool.set(category, levelpool);
                    effectpoolLookup.set(category, new Map());
                }
                var effects = levelpool.get(level);
                if (effects == null) {
                    effects = [];
                    levelpool.set(level, effects);
                    effectpoolLookup.get(category).set(level, new Map());
                }
                effects.push({name: name, description: description});
                effectpoolLookup.get(category).get(level).set(name, description);
            }

            // Melee weapons
            addItem("Melee", "Combat Knife", "");
            addItem("Melee", "Super Sledge", "");
            addItem("Melee", "Switchblade", "");
            addItem("Melee", "Pickaxe", "");
            addItem("Melee", "Power Fist", "");
            addItem("Melee", "Knuckles", "");
            addItem("Melee", "Boxing Glove", "");
            addItem("Melee", "Pitchfork", "");
            addItem("Melee", "Shishkebab", "");
            addItem("Melee", "Machete", "");
            addItem("Melee", "Spear", "");
            addItem("Melee", "Ripper", "");
            addItem("Melee", "Mr. Handy Buzz Blade", "");
            addItem("Melee", "Assaultron Blade", "");
            addItem("Melee", "Bovie knife", "");
            addItem("Melee", "Chinese Officer Sword", "");
            addItem("Melee", "Cultist Blade", "");
            addItem("Melee", "Cultist Dagger", "");
            addItem("Melee", "Guitar Sword", "");
            addItem("Melee", "Lead Pipe", "");
            addItem("Melee", "Pipe Wrench", "");
            addItem("Melee", "Revolutionary Sword", "");
            addItem("Melee", "Rolling Pin", "");
            addItem("Melee", "Baton", "");
            addItem("Melee", "Sickle", "");
            addItem("Melee", "Ski Sword", "");
            addItem("Melee", "Black Diamond", "");
            addItem("Melee", "Walking Cane", "");
            addItem("Melee", "Tire Iron", "");
            addItem("Melee", "Baseball Bat", "");
            addItem("Melee", "Board", "");
            addItem("Melee", "Fire Axe", "");
            addItem("Melee", "Golf Club", "");
            addItem("Melee", "Grognak's Axe", "");
            addItem("Melee", "Multi-purpose Axe", "");
            addItem("Melee", "Pole hook", "");
            addItem("Melee", "Pool cue", "");
            addItem("Melee", "War drum", "");
            addItem("Melee", "Death Tambo", "");
            addItem("Melee", "Deathclaw Gauntlet", "");
            addItem("Melee", "Mole Miner Gauntlet", "");
            addItem("Melee", "Meat hook", "");
            addItem("Melee", "Drill", "nostar");

            // Ranged weapons
            addItem("Ranged", ".44 Pistol", "");
            addItem("Ranged", "10mm Pistol", "");
            addItem("Ranged", "Handmade Rifle", "");
            addItem("Ranged", "Hunting Rifle", "");
            addItem("Ranged", "10mm SMG", "");
            addItem("Ranged", "Submachine Gun", "");
            addItem("Ranged", "Gatling Gun", "");
            addItem("Ranged", "Minigun", "");
            addItem("Ranged", "50 cal Machine Gun", "");
            addItem("Ranged", "Western Revolver", "");
            addItem("Ranged", "Pump-action Shotgun", "");
            addItem("Ranged", "Combat Shotgun", "");
            addItem("Ranged", "Combat Rifle", "");
            addItem("Ranged", "Single Action Revolver", "");
            addItem("Ranged", "Harpoon Gun", "");
            addItem("Ranged", "Assault Rifle", "");
            addItem("Ranged", "Crossbow", "");
            addItem("Ranged", "Gauss Rifle", "");
            addItem("Ranged", "Lever Action Rifle", "");
            addItem("Ranged", "Radium Rifle", "");
            addItem("Ranged", "Railway Rifle", "");
            addItem("Ranged", "Syringer", "nostar");
            addItem("Ranged", "Double-barrel Shotgun", "");
            addItem("Ranged", "Pipe Gun", "");
            addItem("Ranged", "Pipe Bolt-action", "");
            addItem("Ranged", "Pipe Revolver", "");
            addItem("Ranged", "Light Machine Gun", "");

            // black powder can't spawn as Double/Quad
            addItem("Ranged", "Black Powder Pistol", "blackpowder");
            addItem("Ranged", "Black Powder Rifle", "blackpowder");
            addItem("Ranged", "Black Powder Blunderbuss", "blackpowder");
            addItem("Ranged", "The Dragon", "blackpowder");

            // Ranged weapons that can't spawn as Explosive

            addItem("Ranged", "Gatling Plasma", "energy");
            addItem("Ranged", "Gatling Laser", "energy");
            addItem("Ranged", "Ultracite Gatling Laser", "energy");
            addItem("Ranged", "Plasma Gun", "energy");
            addItem("Ranged", "Laser Pistol", "energy");
            addItem("Ranged", "Ultracite Laser Gun", "energy");
            addItem("Ranged", "Laser Rifle", "energy");
            addItem("Ranged", "Tesla Rifle", "energy");
            addItem("Ranged", "Broadsider", "explosive");
            addItem("Ranged", "Auto Grenade Launcher", "explosive");
            addItem("Ranged", "Fat Man", "explosive");
            addItem("Ranged", "M79 Grenade Launcher", "explosive");
            addItem("Ranged", "Missile Launcher", "explosive");
            addItem("Ranged", "Gamma Gun", "energy");
            addItem("Ranged", "Cryolator", "energy");
            addItem("Ranged", "Salvaged Assaultron Head", "energy,assaultronhead");
            addItem("Ranged", "Flamer", "energy");

            // oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo
            // Armors
            // ------

            // Leather
            addItem("Armor", "Leather Chest Piece", "");
            addItem("Armor", "Leather Left Arm", "");
            addItem("Armor", "Leather Right Arm", "");
            addItem("Armor", "Leather Left Leg", "");
            addItem("Armor", "Leather Right Leg", "");

            addItem("Armor", "Sturdy Leather Chest Piece", "");
            addItem("Armor", "Sturdy Leather Left Arm", "");
            addItem("Armor", "Sturdy Leather Right Arm", "");
            addItem("Armor", "Sturdy Leather Left Leg", "");
            addItem("Armor", "Sturdy Leather Right Leg", "");

            addItem("Armor", "Heavy Leather Chest Piece", "");
            addItem("Armor", "Heavy Leather Left Arm", "");
            addItem("Armor", "Heavy Leather Right Arm", "");
            addItem("Armor", "Heavy Leather Left Leg", "");
            addItem("Armor", "Heavy Leather Right Leg", "");

            // Metal
            addItem("Armor", "Metal Chest Piece", "");
            addItem("Armor", "Metal Left Arm", "");
            addItem("Armor", "Metal Right Arm", "");
            addItem("Armor", "Metal Left Leg", "");
            addItem("Armor", "Metal Right Leg", "");

            addItem("Armor", "Sturdy Metal Chest Piece", "");
            addItem("Armor", "Sturdy Metal Left Arm", "");
            addItem("Armor", "Sturdy Metal Right Arm", "");
            addItem("Armor", "Sturdy Metal Left Leg", "");
            addItem("Armor", "Sturdy Metal Right Leg", "");

            addItem("Armor", "Heavy Metal Chest Piece", "");
            addItem("Armor", "Heavy Metal Left Arm", "");
            addItem("Armor", "Heavy Metal Right Arm", "");
            addItem("Armor", "Heavy Metal Left Leg", "");
            addItem("Armor", "Heavy Metal Right Leg", "");

            // Combat
            addItem("Armor", "Combat Armor Chest Piece", "");
            addItem("Armor", "Combat Armor Left Arm", "");
            addItem("Armor", "Combat Armor Right Arm", "");
            addItem("Armor", "Combat Armor Left Leg", "");
            addItem("Armor", "Combat Armor Right Leg", "");

            addItem("Armor", "Sturdy Combat Armor Chest Piece", "");
            addItem("Armor", "Sturdy Combat Armor Left Arm", "");
            addItem("Armor", "Sturdy Combat Armor Right Arm", "");
            addItem("Armor", "Sturdy Combat Armor Left Leg", "");
            addItem("Armor", "Sturdy Combat Armor Right Leg", "");

            addItem("Armor", "Heavy Combat Armor Chest Piece", "");
            addItem("Armor", "Heavy Combat Armor Left Arm", "");
            addItem("Armor", "Heavy Combat Armor Right Arm", "");
            addItem("Armor", "Heavy Combat Armor Left Leg", "");
            addItem("Armor", "Heavy Combat Armor Right Leg", "");

            // Robot
            addItem("Armor", "Robot Armor Chest Piece", "");
            addItem("Armor", "Robot Armor Left Arm", "");
            addItem("Armor", "Robot Armor Right Arm", "");
            addItem("Armor", "Robot Armor Left Leg", "");
            addItem("Armor", "Robot Armor Right Leg", "");

            addItem("Armor", "Robot Sturdy Armor Chest Piece", "");
            addItem("Armor", "Robot Sturdy Armor Left Arm", "");
            addItem("Armor", "Robot Sturdy Armor Right Arm", "");
            addItem("Armor", "Robot Sturdy Armor Left Leg", "");
            addItem("Armor", "Robot Sturdy Armor Right Leg", "");

            addItem("Armor", "Robot Heavy Armor Chest Piece", "");
            addItem("Armor", "Robot Heavy Armor Left Arm", "");
            addItem("Armor", "Robot Heavy Armor Right Arm", "");
            addItem("Armor", "Robot Heavy Armor Left Leg", "");
            addItem("Armor", "Robot Heavy Armor Right Leg", "");

            // Marine
            addItem("Armor", "Marine Armor Chest Piece", "");
            addItem("Armor", "Marine Armor Left Arm", "");
            addItem("Armor", "Marine Armor Right Arm", "");
            addItem("Armor", "Marine Armor Left Leg", "");
            addItem("Armor", "Marine Armor Right Leg", "");

            // Trapper
            addItem("Armor", "Trapper Chest Piece", "");
            addItem("Armor", "Trapper Left Arm", "");
            addItem("Armor", "Trapper Right Arm", "");
            addItem("Armor", "Trapper Left Leg", "");
            addItem("Armor", "Trapper Right Leg", "");

            addItem("Armor", "Heavy Trapper Chest Piece", "");
            addItem("Armor", "Heavy Trapper Left Arm", "");
            addItem("Armor", "Heavy Trapper Right Arm", "");
            addItem("Armor", "Heavy Trapper Left Leg", "");
            addItem("Armor", "Heavy Trapper Right Leg", "");

            // Scout
            addItem("Armor", "Forrest Scout Armor Chest Piece", "");
            addItem("Armor", "Forrest Scout Armor Left Arm", "");
            addItem("Armor", "Forrest Scout Armor Right Arm", "");
            addItem("Armor", "Forrest Scout Armor Left Leg", "");
            addItem("Armor", "Forrest Scout Armor Right Leg", "");


            // Urban Scout Armor doesn't seem to exist as legendary drop
            // addItem("Armor", "Urban Scout Armor Chest Piece", "");
            // addItem("Armor", "Urban Scout Armor Left Arm", "");
            // addItem("Armor", "Urban Scout Armor Right Arm", "");
            // addItem("Armor", "Urban Scout Armor Left Leg", "");
            // addItem("Armor", "Urban Scout Armor Right Leg", "");

            // Wooden
            addItem("Armor", "Wooden Chest Piece", "wood");
            addItem("Armor", "Wooden Left Arm", "wood");
            addItem("Armor", "Wooden Right Arm", "wood");
            addItem("Armor", "Wooden Left Leg", "wood");
            addItem("Armor", "Wooden Right Leg", "wood");

            // Raider
            addItem("Armor", "Raider Chest Piece", "");
            addItem("Armor", "Raider Left Arm", "");
            addItem("Armor", "Raider Right Arm", "");
            addItem("Armor", "Raider Left Leg", "");
            addItem("Armor", "Raider Right Leg", "");

            addItem("Armor", "Sturdy Raider Chest Piece", "");
            addItem("Armor", "Sturdy Raider Left Arm", "");
            addItem("Armor", "Sturdy Raider Right Arm", "");
            addItem("Armor", "Sturdy Raider Left Leg", "");
            addItem("Armor", "Sturdy Raider Right Leg", "");

            addItem("Armor", "Heavy Raider Chest Piece", "");
            addItem("Armor", "Heavy Raider Left Arm", "");
            addItem("Armor", "Heavy Raider Right Arm", "");
            addItem("Armor", "Heavy Raider Left Leg", "");
            addItem("Armor", "Heavy Raider Right Leg", "");


            // Melee effects, prefixes
            addEffect("Melee", 0, "Bloodied", "Does more damage the lower your health is");
            addEffect("Melee", 0, "Furious", "Damage increased after each consecutive hit on the same target");
            addEffect("Melee", 0, "Instigating", "Double damage if target is full health");
            addEffect("Melee", 0, "Anti-armor", "Ignores 50% of your target's armor");
            addEffect("Melee", 0, "Vampire's", "Gain brief health regeneration when you hit an enemy");
            addEffect("Melee", 0, "Berserker's", "More damage the lower your damage resistance");
            addEffect("Melee", 0, "Junkie's", "More damage the more your withdrawal effects");
            addEffect("Melee", 0, "Suppressor's", "Reduce your target's damage output by 20% for 3s");
            addEffect("Melee", 0, "Assassin's", "+10% damage to players");
            addEffect("Melee", 0, "Nocturnal", "Damage increased by the night and reduced by the day");
            addEffect("Melee", 0, "Mutant's", "Damage increased by 10% if you are mutated");
            addEffect("Melee", 0, "Stalker's", "If not in combat, false00% VATS accuracy at 50% increased AP cost");
            addEffect("Melee", 0, "Executioner's", "50% increased damage if target is below 40% health");
            addEffect("Melee", 0, "Troubleshooter's", "+30% damage to robots");
            addEffect("Melee", 0, "Ghoul slayer's", "+30% damage to ghouls");
            addEffect("Melee", 0, "Mutant slayer's", "+30% damage to super mutants");
            addEffect("Melee", 0, "Hunter's", "+30% damage to animals");
            addEffect("Melee", 0, "Exterminator's", "+30% damage to Mirelurks and bugs");
            addEffect("Melee", 0, "Zealot's", "+30% damage to scorched");

            // Melee effects, major
            addEffect("Melee", 1, "Limb", "+50% limb damage");
            addEffect("Melee", 1, "Speed", "40% increased swing speed");
            addEffect("Melee", 1, "Power", "40% more power attack damage");
            addEffect("Melee", 1, "Reflect", "Reflect 50% of damage while blocking");

            // Melee effects, minor
            addEffect("Melee", 2, "Strength", "+1 Strength");
            addEffect("Melee", 2, "Endurance", "+1 Endurance");
            addEffect("Melee", 2, "Agility", "+1 Agility");
            addEffect("Melee", 2, "Powerdamage", "Take 40% less damage while power attacking");
            addEffect("Melee", 2, "Blocking", "Take 15% less damage while blocking");
            addEffect("Melee", 2, "Weight", "90% reduced weight");

            // Ranged effects, prefix
            // anti-armor should be first so that energy can filter it out
            addEffect("Ranged", 0, "Anti-armor", "Ignores 50% of your target's armor");
            addEffect("Ranged", 0, "Bloodied", "Does more damage the lower your health is");
            addEffect("Ranged", 0, "Furious", "Damage increased after each consecutive hit on the same target");
            addEffect("Ranged", 0, "Instigating", "Double damage if target is full health");
            addEffect("Ranged", 0, "Vampire's", "Gain brief health regeneration when you hit an enemy");
            addEffect("Ranged", 0, "Berserker's", "More damage the lower your damage resistance");
            addEffect("Ranged", 0, "Junkie's", "More damage the more your withdrawal effects");
            addEffect("Ranged", 0, "Suppressor's", "Reduce your target's damage output by 20% for 3s");
            addEffect("Ranged", 0, "Assassin's", "+10% damage to players");
            addEffect("Ranged", 0, "Nocturnal", "Damage increased by the night and reduced by the day");
            addEffect("Ranged", 0, "Mutant's", "Damage increased by 10% if you are mutated");
            addEffect("Ranged", 0, "Stalker's", "If not in combat 100% VATS accuracy at 50% increased AP cost");
            addEffect("Ranged", 0, "Executioner's", "50% increased damage if target is below 40% health");
            addEffect("Ranged", 0, "Troubleshooter's", "+30% damage to robots");
            addEffect("Ranged", 0, "Ghoul slayer's", "+30% damage to ghouls");
            addEffect("Ranged", 0, "Mutant slayer's", "+30% damage to super mutants");
            addEffect("Ranged", 0, "Hunter's", "+30% damage to animals");
            addEffect("Ranged", 0, "Exterminator's", "+30% damage to Mirelurks and bugs");
            addEffect("Ranged", 0, "Zealot's", "+30% damage to scorched");
            addEffect("Ranged", 0, "Medic's", "VATS criticals will heal you and your group");
            addEffect("Ranged", 0, "Two shot", "Shoots an additional projectile");
            // these should be the last so that black powder can filter it out
            addEffect("Ranged", 0, "Quad", "Quadruple ammo capacity");
            // addEffect("Ranged", 0, "Double", "Double ammo capacity"); // <---------- can no longer drop apparently

            // Ranged effects, major
            addEffect("Ranged", 1, "VATSCritical", "VATS critical shots do +50% damage");
            addEffect("Ranged", 1, "FireRate", "25% increased fire rate");
            addEffect("Ranged", 1, "Bashing", "Bashing damage increased by 40%");
            addEffect("Ranged", 1, "AimDamage", "10% increased damage while aiming");
            addEffect("Ranged", 1, "VATSChance", "+33% VATS hits chance");
            addEffect("Ranged", 1, "Limb", "+50% limb damage");
            // this should be the last so that Energy/Explosive weapons can filter this out.
            addEffect("Ranged", 1, "Explosive", "Bullets explode for area damage");

            // Ranged effects, minor
            addEffect("Ranged", 2, "Perception", "+1 Perception");
            addEffect("Ranged", 2, "Agility", "+1 Agility");
            addEffect("Ranged", 2, "VATSAction", "25% less VATS Action Point cost");
            addEffect("Ranged", 2, "VATSCriticalMeter", "Your VATS critical meter fills 15% faster");
            addEffect("Ranged", 2, "MoveAim", "Move faster while aiming");
            addEffect("Ranged", 2, "ResistAim", "+50 damage resistance while aiming");
            addEffect("Ranged", 2, "ResistReload", "+250 damage resistance while reloading");
            addEffect("Ranged", 2, "ReloadSpeed", "15% faster reload");
            addEffect("Ranged", 2, "Weight", "90% reduced wight");

            // Ranged effects, prefix
            addEffect("Armor", 0, "Auto stim", "Automatically use a Stimpak when hit while health is 25% or less, once every 60 seconds");
            addEffect("Armor", 0, "Life saving", "While incapacitated, gain 50% chance to revive yourself with a Stimpak, once every minute");
            addEffect("Armor", 0, "Weightless", "Weighs 90% less and does not count as armor for the Chameleon mutation");
            addEffect("Armor", 0, "Chameleon", "Blend with the environment while sneaking and not moving");
            addEffect("Armor", 0, "Cloaking", "Being hit in melee generates a Stealth field once per 30 seconds");
            addEffect("Armor", 0, "Regenerating", "Slowly regenerate health while out of combat");
            addEffect("Armor", 0, "Vanguard's", "Grants up to 35 Damage and Energy Resistance, the higher your health");
            addEffect("Armor", 0, "Bolstering", "Grants up to 35 Damage and Energy Resistance, the lower your health");
            addEffect("Armor", 0, "Unyielding", "Gain +3 to all stats except END when low on health");
            addEffect("Armor", 0, "Nocturnal", "Damage and Energy Resist increase with the night and decrease with the day");
            addEffect("Armor", 0, "Assassin's", "-8% damage from players");
            addEffect("Armor", 0, "Exterminator's", "-15% damage from Mirelurks and bugs");
            addEffect("Armor", 0, "Hunter's", "-15% damage from animals");
            addEffect("Armor", 0, "Troubleshooter's", "-15% damage from robots");
            addEffect("Armor", 0, "Ghoul slayer's", "-15% damage from ghouls");
            addEffect("Armor", 0, "Mutant slayer's", "-15% damage from super mutants");
            addEffect("Armor", 0, "Zealot's", "-15% damage from scorched");
            addEffect("Armor", 0, "Mutant's", "+10 Damage and Energy Resist if you are mutated");

            // Ranged effects, major
            addEffect("Armor", 1, "Strength", "+1 Strength");
            addEffect("Armor", 1, "Perception", "+1 Perception");
            addEffect("Armor", 1, "Endurance", "+1 Endurance");
            addEffect("Armor", 1, "Charisma", "+1 Charisma");
            addEffect("Armor", 1, "Intelligence", "+1 Intelligence");
            addEffect("Armor", 1, "Agility", "+1 Agility");
            addEffect("Armor", 1, "Luck", "+1 Luck");
            addEffect("Armor", 1, "Powered", "Increases action point refresh speed"); // can be an additiona prefix
            addEffect("Armor", 1, "RadiationResist", "+25 radiation resist");
            addEffect("Armor", 1, "Poisoner's", "+25 poison resistance"); // can replace a 's prefix

            // Ranged effects, minor
            addEffect("Armor", 2, "AmmoWeight", "Ammo weight reduced by 20%");
            addEffect("Armor", 2, "WeaponWeight", "Weapon weights reduced by 20%");
            addEffect("Armor", 2, "FoodWeight", "Food, drink and chem weights reduced by 20%");
            addEffect("Armor", 2, "JunkWeight", "Junk weight reduced by 20%");
            addEffect("Armor", 2, "BreatheUnderwater", "Grants the ability to breathe underwater");
            addEffect("Armor", 2, "Sneak", "Become harder to detect while sneaking");
            addEffect("Armor", 2, "Durable", "50% more durability than normal");
            addEffect("Armor", 2, "Sentinel's", "Reduces damage while standing and not moving by 15%"); // can replace a 's prefix
            addEffect("Armor", 2, "BlockingDamage", "Reduces damage while blocking by 15%");
            addEffect("Armor", 2, "SprintDamage", "Reduces damage while sprinting by 15%");
            addEffect("Armor", 2, "Acrobat's", "Falling damage reduced by 50%"); // can replace a 's prefix
            addEffect("Armor", 2, "Lockpick", "Increases size of the sweet spot while picking locks");

            // setup variables

            var setup = {
                tries: 10000,
                progressUpdateItems: 100,
                energyAntiArmor: true,
                energyExplosive: false,
                assaultronMultistar: false,
                woodMultistar: false,
                disallowedDrop: "Prefilter",
                enemyChances: [75, 5, 20],
                enemyDropMatrix: [
                    [100, 0, 0],
                    [55, 45, 0],
                    [40, 35, 25]
                ],
                running: false,
                progress: 0,

                // ------------------------------------------------
                // statistics counter
                // ------------------------------------------------

                statDisallowedDropCount: 0,
                statEffectRetries: 0,
                statItemRetries: 0,
                statEnemyStars: [0, 0, 0],
                statEnemyDropStars: [[0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]],

                // aggregated item/effect stats
                // category -> Map(level: int -> { count: int, effects: Map(effect name -> count) })
                statEffectMap: new Map(),

                // itemName -> { count: int, category, level: Map(int -> { count: int, effects: Map(prefix+major+minor -> count) })}
                statItemMap: new Map(),

                // category -> count
                statCategories: new Map(),

                // each generated item log, use addDrop()
                statItems: [],
            }

            function updateSetup() {
                setup.tries = parseInt(document.getElementById("txtTries").value);

                setup.progressUpdateItems = parseInt(document.getElementById("progressUpdateItems").value);
                setup.energyAntiArmor = document.getElementById("energyAntiArmorYes").checked;
                setup.energyExplosive = document.getElementById("energyExplosiveYes").checked;
                setup.assaultronMultistar = document.getElementById("assaultronMultistarYes").checked;
                setup.woodMultistar = document.getElementById("woodMultistarYes").checked;
                var disallowedDrops = document.getElementsByName("disallowedDrop");

                for (var dd in disallowedDrops) {
                    if (dd.checked) {
                        setup.disallowedDrop = dd.value;
                    }
                }
                
                var enemy1chanceValue = parseFloat(document.getElementById("enemy1chance").value);
                var enemy2chanceValue = parseFloat(document.getElementById("enemy2chance").value);
                var enemy3chanceValue = parseFloat(document.getElementById("enemy3chance").value);

                var sumChance = enemy1chanceValue + enemy2chanceValue + enemy3chanceValue;

                setup.enemyChances = [100 * enemy1chanceValue / sumChance, 100 * enemy2chanceValue / sumChance, 100 * enemy3chanceValue / sumChance];

                var enemy2drop1Value = parseFloat(document.getElementById("enemy2drop1chance").value);
                var enemy2drop2Value = parseFloat(document.getElementById("enemy2drop2chance").value);

                var sum2Chance = enemy2drop1Value + enemy2drop2Value;

                setup.enemyDropMatrix[1] = [100 * enemy2drop1Value / sum2Chance, 100 * enemy2drop2Value / sum2Chance, 0];

                var enemy3drop1Value = parseFloat(document.getElementById("enemy3drop1chance").value);
                var enemy3drop2Value = parseFloat(document.getElementById("enemy3drop2chance").value);
                var enemy3drop3Value = parseFloat(document.getElementById("enemy3drop3chance").value);

                var sum3Chance = enemy3drop1Value + enemy3drop2Value + enemy3drop3Value;

                setup.enemyDropMatrix[2] = [100 * enemy3drop1Value / sum3Chance, 100 * enemy3drop2Value / sum3Chance, 100 * enemy3drop3Value / sum3Chance];

                setup.statDisallowedDropCount = 0;
                setup.statEffectRetries = 0;
                setup.statItemRetries = 0;
                setup.statEnemyStars = [0, 0, 0];
                setup.statEnemyDropStars = [[0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]];
                setup.statEffectMap = new Map();
                setup.statItemMap = new Map();
                setup.statItems = [];
                setup.statCategories = new Map();
            }

            document.getElementById("presetDefault").onclick = function() {
                document.getElementById("enemy1chance").value = "75";
                document.getElementById("enemy2chance").value = "5";
                document.getElementById("enemy3chance").value = "20";

                document.getElementById("enemy2drop1chance").value = "55";
                document.getElementById("enemy2drop2chance").value = "45";

                document.getElementById("enemy3drop1chance").value = "40";
                document.getElementById("enemy3drop2chance").value = "35";
                document.getElementById("enemy3drop3chance").value = "25";
            };
            document.getElementById("presetMaxLevel").onclick = function() {
                document.getElementById("enemy2drop1chance").value = "0";
                document.getElementById("enemy2drop2chance").value = "100";

                document.getElementById("enemy3drop1chance").value = "0";
                document.getElementById("enemy3drop2chance").value = "0";
                document.getElementById("enemy3drop3chance").value = "100";
            };

            var tabNames = ["tabSetup", "tabStars", "tabEffects", "tabArmor", "tabMelee", "tabRanged", "tabItem", "tabStreaks"];

            function switchTab(tabId) {
                for (var idIdx in tabNames) {
                    var id = tabNames[idIdx];
                    var tabDiv = document.getElementById(id);
                    var tabBtn = document.getElementById(id + "Btn");
                    if (tabId == id) {
                        tabDiv.style.display = "block";
                        tabBtn.style.backgroundColor = "lightgreen";
                    } else {
                        tabDiv.style.display = "none";
                        tabBtn.style.backgroundColor = "";
                    }
                }
            }

            for (var idIdx in tabNames) {
                var id = tabNames[idIdx];
                var tabBtn = document.getElementById(id + "Btn");
                let idl = id;
                tabBtn.onclick = function() {
                    switchTab(idl);
                };
            }

            document.getElementById("btnRun").onclick = function() {
                if (setup.running) {
                    clearInterval(setup.handle);
                    setup.running = false;
                    setup.handle = undefined;
                    document.getElementById("btnRun").innerText = "Run";
                } else {
                    updateSetup();

                    setup.running = true;
                    setup.progress = 0;
                    document.getElementById("btnRun").innerText = "Stop";
                    setup.handle = setInterval(rollLoot, 1);

                    // switch to the overview tab
                    if (document.getElementById("tabSetup").style.display == "block") {
                        switchTab("tabStars");
                    }

                    updateStatisticsPanels();
                }
            };

            function rollLoot() {
                try {
                    for (var batch = 0; batch < setup.progressUpdateItems; batch++) {
                        if (setup.tries <= setup.progress) {
                            break;
                        }
                        setup.progress++;

                        rollStep();

                    }
                } finally {
                    updateStatisticsPanels();

                    if (setup.tries <= setup.progress) {
                        clearInterval(setup.handle);
                        setup.running = false;
                        setup.handle = undefined;
                        document.getElementById("btnRun").innerText = "Run";
                    }
                }
            }

            function addDrop(category, itemName, enemyStar, itemStar, prefix, major, minor) {
                setup.statItems.push({
                    category: category, 
                    itemName: itemName, 
                    enemyStar: enemyStar, 
                    itemStar: itemStar, 
                    prefix: prefix, 
                    major: major, 
                    minor: minor
                });
            }

            function addEffectMap(category, level, effectName) {
                var categoryObj = setup.statEffectMap.get(category);
                if (categoryObj == null) {
                    categoryObj = new Map();
                    setup.statEffectMap.set(category, categoryObj);
                }

                var levelObj = categoryObj.get(level);
                if (levelObj == null) {
                    levelObj = { count: 0, effects: new Map() };
                    categoryObj.set(level, levelObj);
                }

                levelObj.count++;

                var effectsCount = levelObj.effects.get(effectName);
                if (effectsCount == null) {
                    levelObj.effects.set(effectName, 1);
                } else {
                    levelObj.effects.set(effectName, effectsCount + 1);
                }
            }

            function addItemMap(itemName, category, stars, prefix, major, minor) {
                var itemObj = setup.statItemMap.get(itemName);
                if (itemObj == null) {
                    itemObj = { count: 0, category: category, stars: new Map() };
                    setup.statItemMap.set(itemName, itemObj);
                }
                itemObj.count++;

                var starsObj = itemObj.stars.get(stars);
                if (starsObj == null) {
                    starsObj = { count: 0, effects: new Map() };
                    itemObj.stars.set(stars, starsObj);
                }
                starsObj.count++;

                if (minor !== "") {
                    key = prefix + "," + major + "," + minor;
                    effectCount = starsObj.effects.get(key);
                    if (effectCount == null) {
                        starsObj.effects.set(key, 1);
                    } else {
                        starsObj.effects.set(key, effectCount + 1);
                    }
                } else
                if (major !== "") {
                    var key = prefix + "," + major;
                    effectCount = starsObj.effects.get(key);
                    if (effectCount == null) {
                        starsObj.effects.set(key, 1);
                    } else {
                        starsObj.effects.set(key, effectCount + 1);
                    }
                } else {
                    var effectCount = starsObj.effects.get(prefix);
                    if (effectCount == null) {
                        starsObj.effects.set(prefix, 1);
                    } else {
                        starsObj.effects.set(prefix, effectCount + 1);
                    }
                }

                var catCount = setup.statCategories.get(category);
                if (catCount == null) {
                    setup.statCategories.set(category, 1);
                } else {
                    setup.statCategories.set(category, catCount + 1);
                }
                catCount = setup.statCategories.get(category + stars);
                if (catCount == null) {
                    setup.statCategories.set(category + stars, 1);
                } else {
                    setup.statCategories.set(category + stars, catCount + 1);
                }
            }

            function rollStep() {
                if (setup.disallowedDrop == "Prefilter") {
                    // roll for enemy star
                    var enemyStarRNG = Math.random() * 100.0;

                    var enemyStar = 0;

                    if (enemyStarRNG < setup.enemyChances[0]) {
                        enemyStar = 1;
                    } else if (enemyStarRNG < setup.enemyChances[0] + setup.enemyChances[1]) {
                        enemyStar = 2;
                    } else {
                        enemyStar = 3;
                    }
                    setup.statEnemyStars[enemyStar - 1]++;

                    // roll for item star
                    var itemStarRNG = Math.random() * 100.0;

                    var itemStar = 0;
                    var enemyDropMatrixRow = setup.enemyDropMatrix[enemyStar - 1];
                    if (itemStarRNG < enemyDropMatrixRow[0]) {
                        itemStar = 1;
                    } else if (itemStarRNG < enemyDropMatrixRow[0] + enemyDropMatrixRow[1]) {
                        itemStar = 2;
                    } else {
                        itemStar = 3;
                    }

                    // roll for an item
                    var itemIndex = Math.floor(Math.random() * lootpool.length);

                    var item = lootpool[itemIndex];

                    // nostar items have no legendary effect
                    if (item.tags.includes("nostar")) {
                        setup.statEnemyDropStars[enemyStar - 1][0]++;
                        addDrop(item.category, item.name, enemyStar, 0, "", "", "");
                        addItemMap(item.name, item.category, 0, "", "", "");
                        // nothing to roll further
                        return;
                    }

                    // wood may not be more than 1 star based on setup
                    if ((item.tags.includes("wood") && !setup.woodMultistar)
                            || (item.tags.includes("assaultronhead") && !setup.assaultronMultistar)) {
                        itemStar = 1;
                    }

                    setup.statEnemyDropStars[enemyStar - 1][itemStar]++;

                    var prefixPool = effectpool.get(item.category).get(0);

                    var prefixPoolLen = prefixPool.length;
                    var prefixOffset = 0;

                    // energy weapons may not drop as Anti-armor based on setup
                    if (item.tags.includes("energy") && !setup.energyAntiArmor) {
                        prefixOffset++;
                        prefixPoolLen--;
                    }

                    // black powder can't roll as Double/Quad
                    if (item.tags.includes("blackpowder")) {
                        prefixPoolLen -= 1;
                    }

                    // roll for prefix
                    var prefixIndex = Math.floor(Math.random() * prefixPoolLen);

                    var prefix = prefixPool[prefixIndex + prefixOffset];

                    if (itemStar == 1) {
                        addDrop(item.category, item.name, enemyStar, 1, prefix.name, "", "");
                        addEffectMap(item.category, 1, prefix.name);
                        addItemMap(item.name, item.category, 1, prefix.name, "", "");

                        return;
                    }

                    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~11

                    var majorPool = effectpool.get(item.category).get(1);
                    var majorPoolLen = majorPool.length;

                    // explosive can't drop with Explosive prefix
                    if (item.tags.includes("explosive")) {
                        majorPoolLen--;
                    } else 
                    // energy weapons may not drop as explosive based on setup
                    if (item.tags.includes("energy") && !setup.energyExplosive) {
                        majorPoolLen--;
                    }

                    var majorIndex = Math.floor(Math.random() * majorPoolLen);

                    var major = majorPool[majorIndex];

                    if (itemStar == 2) {
                        addDrop(item.category, item.name, enemyStar, 2, prefix.name, major.name, "");
                        addEffectMap(item.category, 2, major.name);
                        addItemMap(item.name, item.category, 2, prefix.name, major.name, "");

                        return;
                    }

                    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~11

                    var minorPool = effectpool.get(item.category).get(2);
                    var minorPoolLen = minorPool.length;

                    // Not aware of any minor effect eclusion

                    var minorIndex = Math.floor(Math.random() * minorPoolLen);

                    var minor = minorPool[minorIndex];

                    addDrop(item.category, item.name, enemyStar, 2, prefix.name, major.name, minor.name);
                    addEffectMap(item.category, 3, minor.name);
                    addItemMap(item.name, item.category, 3, prefix.name, major.name, minor.name);
                }
            }

            function sumOf(array) {
                var sum = 0.0;
                for (var idx in array) {
                    sum += array[idx];
                }
                return sum;
            }
            

            function prepareEffectStatsTable() {
                var categories = ["Armor", "Melee", "Ranged"];
                var levels = ["Prefix", "Major", "Minor"];

                for (var cat in categories) {
                    for (var lvl in levels) {

                        var leveledeffects = effectpool.get(categories[cat]).get(parseInt(lvl));

                        leveledeffects = leveledeffects.slice();

                        leveledeffects.sort(function(a, b) {
                            if (a.name < b.name) {
                                return -1;
                            }
                            if (a.name > b.name) {
                                return 1;
                            }
                            return 0;
                        });

                        document.getElementById("stat" + categories[cat] + levels[lvl] + "Count").innerText = "" + leveledeffects.length;
                        document.getElementById("stat" + categories[cat] + levels[lvl] + "Percent").innerText = "" + (100.0 / leveledeffects.length).toFixed(3) + " %";

                        var table = document.getElementById("stat" + categories[cat] + levels[lvl]);

                        for (var leidx in leveledeffects) {
                            var le = leveledeffects[leidx];

                            var row = table.insertRow(table.rows.length);

                            var cell0 = row.insertCell(0);
                            cell0.innerText = le.name;
                            cell0.title = le.description;

                            var cell1 = row.insertCell(1);
                            cell1.style.textAlign = 'right';
                            cell1.id = "stat" + categories[cat] + levels[lvl] + le.name + "DropCount";
                            cell1.innerText = "0";

                            var cell2 = row.insertCell(2);
                            cell2.style.textAlign = 'right';
                            cell2.id = "stat" + categories[cat] + levels[lvl] + le.name + "DropPercent";
                        }

                        var rowlast = table.insertRow(table.rows.length);
                        var celllast0 = rowlast.insertCell(0);
                        celllast0.innerText = "Total";
                        celllast0.style.fontWeight = "bold";

                        var celllast1 = rowlast.insertCell(1);
                        celllast1.style.textAlign = "right";
                        celllast1.id = "stat" + categories[cat] + levels[lvl] + "TotalCount";

                        var celllast2 = rowlast.insertCell(2);
                        celllast2.style.textAlign = "right";
                    }
                }
            }

            function updateStatisticsPanels() {
                // update the progress bar
                var percent = (setup.progress * 100.0 / setup.tries);
                document.getElementById("txtProgress").style.width = percent + "%";
                document.getElementById("txtProgressText").innerHTML = percent.toFixed(3) + "%";

                // update the Stars Panel

                document.getElementById("statcount").innerText = "" + setup.progress;

                for (var lvl = 1; lvl < 4; lvl++) {
                    document.getElementById("statenemy" + lvl + "count").innerText = "" + setup.statEnemyStars[lvl - 1];
                    document.getElementById("statenemy" + lvl + "percent").innerText = "" + (setup.statEnemyStars[lvl - 1] * 100.0 / setup.progress).toFixed(3) + " %";

                    for (var drp = 0; drp <= lvl; drp++) {
                        var key = "statenemy" + lvl + "drop" + drp;

                        var cnt = setup.statEnemyDropStars[lvl - 1][drp];

                        document.getElementById(key + "count").innerText = "" + cnt;
                        document.getElementById(key + "percent").innerText = "" + (cnt * 100.0 / sumOf(setup.statEnemyDropStars[lvl - 1])).toFixed(3) + " %";
                        document.getElementById(key + "percenttotal").innerText = "" + (cnt * 100.0 / setup.progress).toFixed(3) + " %";
                    }
                }

                for (var drp = 0; drp <= lvl; drp++) {
                    var key = "statdrop" + drp;

                    var cnt = 0;
                    for (var lvl = 0; lvl < 3; lvl ++) {
                        cnt += setup.statEnemyDropStars[lvl][drp];
                    }

                    document.getElementById(key + "count").innerText = "" + cnt;
                    document.getElementById(key + "percent").innerText = "" + (cnt * 100.0 / setup.progress).toFixed(3) + " %";
                }

                // update effects panel
                var categories = ["Armor", "Melee", "Ranged"];
                var levels = ["Prefix", "Major", "Minor"];

                for (var cat in categories) {
                    for (var lvl in levels) {
                        var catStat = setup.statEffectMap.get(categories[cat]);
                        var catLevelStat = null;
                        if (catStat != null) {
                            catLevelStat = catStat.get(parseInt(lvl) + 1);
                        }

                        var leveledeffects = effectpool.get(categories[cat]).get(parseInt(lvl));
                        for (var eff in leveledeffects) {
                            var effect = leveledeffects[eff];

                            var cellCount = document.getElementById("stat" + categories[cat] + levels[lvl] + effect.name + "DropCount");
                            var cellPercent = document.getElementById("stat" + categories[cat] + levels[lvl] + effect.name + "DropPercent");

                            cellCount.innerText = "0";
                            cellPercent.innerText = "0.000 %";

                            if (catLevelStat != null) {
                                var effectStat = catLevelStat.effects.get(effect.name);
                                if (effectStat != null) {
                                    cellCount.innerText = "" + effectStat;
                                    cellPercent.innerText = "" + (effectStat * 100.0 / catLevelStat.count).toFixed(3) + " %";
                                }
                            }
                        }

                        var totalCount = document.getElementById("stat" + categories[cat] + levels[lvl] + "TotalCount");
                        if (catLevelStat != null) {
                            totalCount.innerText = "" + catLevelStat.count;
                        } else {
                            totalCount.innerText = "0";
                        }
                    }
                }

                // update items panel

                // itemName -> { count: int, category, stars: Map(int -> { count: int, effects: Map(prefix+major+minor -> count) })}
                for (var [itemName, itemStats] of setup.statItemMap) {

                    var categorySum = setup.statCategories.get(itemStats.category);

                    for (var [star, itemEffects] of itemStats.stars) {
                        if (star > 0) {
                            var itemStarKey = "stat" + itemStats.category + "Items" + itemName + "Drop" + star;

                            document.getElementById(itemStarKey + "Count").innerText = "" + itemEffects.count;
                            document.getElementById(itemStarKey + "Percent").innerText = "" + (itemEffects.count * 100.0 / itemStats.count).toFixed(3) + " %";
                            document.getElementById(itemStarKey + "PercentTotal").innerText = "" + (itemEffects.count * 100.0 / categorySum).toFixed(3) + " %";
                        }
                    }

                    var itemStarKey = "stat" + itemStats.category + "Items" + itemName + "Drop";

                    document.getElementById(itemStarKey + "Count").innerText = "" + itemStats.count;
                    document.getElementById(itemStarKey + "Percent").innerText = "" + (itemStats.count * 100.0 / categorySum).toFixed(3) + " %";
                }

                for (var cat in categories) {
                    var category = categories[cat];
                    var categorySum = setup.statCategories.get(category);

                    for (var lvl = 1; lvl < 4; lvl++) {
                        var key = "stat" + category + "ItemsDrop" + lvl;
                        var val = setup.statCategories.get(category + lvl);
                        if (val != null) {
                            document.getElementById(key + "Count").innerText = "" + val;
                            document.getElementById(key + "Percent").innerText = "" + (val * 100.0 / categorySum).toFixed(3) + " %";
                        } else {
                            document.getElementById(key + "Count").innerText = "0";
                            document.getElementById(key + "Percent").innerText = "0.000 %";
                        }
                    }

                    var key = "stat" + category + "ItemsDrop";
                    if (categorySum > 0) {
                        document.getElementById(key + "Count").innerText = "" + categorySum;
                        document.getElementById(key + "Percent").innerText = "" + (categorySum * 100.0 / setup.progress).toFixed(3) + " %";
                    } else {
                        document.getElementById(key + "Count").innerText = "0";
                        document.getElementById(key + "Percent").innerText = "0.000 %";
                    }
                }

                // update currently selected item details table
                updateSelectedItemTables();
            }

            function resortItemTable(comparator, tableName) {
                var table = document.getElementById(tableName);

                var oldRows = [];

                for (var i = table.rows.length - 2; i >= 2; i--) {
                    var cellIds = [];
                    var cellTexts = [];

                    var tr = table.rows[i];

                    for (var j = 0; j < tr.cells.length; j++) {
                        cellIds.push(tr.cells[j].id);
                        cellTexts.push(tr.cells[j].innerText);
                    }
                    
                    oldRows.push({
                        name: tr.cells[0].innerText,
                        count: parseInt(tr.cells[10].innerText),
                        ids: cellIds,
                        texts: cellTexts
                    });

                    table.deleteRow(i);
                }

                oldRows.sort(comparator);

                for (var i = 0; i < oldRows.length; i++) {
                    var tr = table.insertRow(i + 2);

                    var r = oldRows[i];

                    for (var j = 0; j < r.ids.length; j++) {
                        c = tr.insertCell(j);
                        c.id = r.ids[j];
                        c.innerText = r.texts[j];
                        if (j != 0) {
                            c.style.textAlign = "right";
                        }
                    }
                }
            }

            function resortEffectsTable(comparator) {
                var categories = ["Armor", "Melee", "Ranged"];
                var levels = ["Prefix", "Major", "Minor"];

                for (var cat in categories) {
                    for (var lvl in levels) {
                        var table = document.getElementById("stat" + categories[cat] + levels[lvl]);

                        var data = [];
                        for (var row = table.rows.length - 2; row >= 2; row--) {
                            var tr = table.rows[row].cells;

                            data.push({
                                name: tr[0].innerText, 
                                description: tr[0].title,
                                count: parseInt(tr[1].innerText), 
                                percent: tr[2].innerText});

                            table.deleteRow(row);
                        }

                        data.sort(comparator);

                        var targetIdx = 2;
                        for (var entry in data) {
                            var row = data[entry];

                            var tr = table.insertRow(targetIdx++);

                            var cell0 = tr.insertCell(0);
                            cell0.innerText = row.name;
                            cell0.title = row.description;

                            var cell1 = tr.insertCell(1);
                            cell1.style.textAlign = 'right';
                            cell1.id = "stat" + categories[cat] + levels[lvl] + row.name + "DropCount";
                            cell1.innerText = "" + row.count;

                            var cell2 = tr.insertCell(2);
                            cell2.style.textAlign = 'right';
                            cell2.id = "stat" + categories[cat] + levels[lvl] + row.name + "DropPercent";
                            cell2.innerText = row.percent;
                        }
                    }
                }
            }

            document.getElementById("effectsSortByPercent").onclick = function() {
                resortEffectsTable(function(a, b) {
                    if (a.count < b.count) {
                        return 1;
                    }
                    if (a.count > b.count) {
                        return -1;
                    }
                    return 0;
                });
            };

            document.getElementById("effectsSortByName").onclick = function() {
                resortEffectsTable(function(a, b) {
                    if (a.name < b.name) {
                        return -1;
                    }
                    if (a.name > b.name) {
                        return 1;
                    }
                    return 0;
                });
            };

            document.getElementById("armorsSortByPercent").onclick = function() {
                resortItemTable(function(a, b) {
                    if (a.count < b.count) {
                        return 1;
                    }
                    if (a.count > b.count) {
                        return -1;
                    }
                    return 0;
                }, "statArmorItems");
            };

            document.getElementById("armorsSortByName").onclick = function() {
                resortItemTable(function(a, b) {
                    if (a.name < b.name) {
                        return -1;
                    }
                    if (a.name > b.name) {
                        return 1;
                    }
                    return 0;
                }, "statArmorItems");
            };

            document.getElementById("meleesSortByPercent").onclick = function() {
                resortItemTable(function(a, b) {
                    if (a.count < b.count) {
                        return 1;
                    }
                    if (a.count > b.count) {
                        return -1;
                    }
                    return 0;
                }, "statMeleeItems");
            };

            document.getElementById("meleesSortByName").onclick = function() {
                resortItemTable(function(a, b) {
                    if (a.name < b.name) {
                        return -1;
                    }
                    if (a.name > b.name) {
                        return 1;
                    }
                    return 0;
                }, "statMeleeItems");
            };

            document.getElementById("rangedsSortByPercent").onclick = function() {
                resortItemTable(function(a, b) {
                    if (a.count < b.count) {
                        return 1;
                    }
                    if (a.count > b.count) {
                        return -1;
                    }
                    return 0;
                }, "statRangedItems");
            };

            document.getElementById("rangedsSortByName").onclick = function() {
                resortItemTable(function(a, b) {
                    if (a.name < b.name) {
                        return -1;
                    }
                    if (a.name > b.name) {
                        return 1;
                    }
                    return 0;
                }, "statRangedItems");
            };

            function prepareItemStatsTables() {
                var categories = ["Armor", "Melee", "Ranged"];

                for (var cat in categories) {
                    var category = categories[cat];

                    var items = [];

                    for (var poolItemIdx in lootpool) {
                        var poolItem = lootpool[poolItemIdx];
                        if (poolItem.category == category) {
                            items.push(poolItem.name);
                        }
                    }

                    items.sort(function(a, b) {
                        if (a < b) {
                            return -1;
                        }
                        if (a > b) {
                            return 1;
                        }
                        return 0;
                    });

                    var overview = document.getElementById("stat" + categories[cat] + "ItemsOverview");
                    overview.innerHTML = "<b>Name</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
                     + items.length + " (" + (items.length * 100.0 / lootpool.length).toFixed(3) + " % pool, " 
                     + (100.0 / items.length).toFixed(3) + "% an item)";
                     overview.style.fontWeight = "normal";
                    

                    var key = "stat" + categories[cat] + "Items";
                    var table = document.getElementById(key);

                    for (var poolItemIdx in items) {
                        var poolItem = items[poolItemIdx];

                        var row = table.insertRow(table.rows.length);

                        var cell = row.insertCell(row.cells.length);
                        cell.innerText = poolItem;
                        cell.id = key + poolItem

                        for (var j = 1; j < 4; j++) {
                            cell = row.insertCell(row.cells.length);
                            cell.innerText = "0";
                            cell.style.textAlign = "right";
                            cell.id = key + poolItem + "Drop" + j + "Count";

                            cell = row.insertCell(row.cells.length);
                            cell.innerText = "0.000 %";
                            cell.style.textAlign = "right";
                            cell.id = key + poolItem + "Drop" + j + "Percent";

                            cell = row.insertCell(row.cells.length);
                            cell.innerText = "0.000 %";
                            cell.style.textAlign = "right";
                            cell.id = key + poolItem + "Drop" + j + "PercentTotal";
                        }

                        cell = row.insertCell(row.cells.length);
                        cell.innerText = "0";
                        cell.style.textAlign = "right";
                        cell.id = key + poolItem + "DropCount";

                        cell = row.insertCell(row.cells.length);
                        cell.innerText = "0.000 %";
                        cell.style.textAlign = "right";
                        cell.id = key + poolItem + "DropPercent";
                    }

                    var row = table.insertRow(table.rows.length);
                    
                    var cell = row.insertCell(row.cells.length);
                    cell.innerText = "Total";
                    row.style.fontWeight = "bold";

                    for (var j = 1; j < 4; j++) {
                        cell = row.insertCell(row.cells.length);
                        cell.innerText = "0";
                        cell.style.textAlign = "right";
                        cell.id = key + "Drop" + j + "Count";

                        cell = row.insertCell(row.cells.length);
                        cell.innerText = "0.000 %";
                        cell.colSpan = "2";
                        cell.style.textAlign = "right";
                        cell.id = key + "Drop" + j + "Percent";
                    }

                    cell = row.insertCell(row.cells.length);
                    cell.innerText = "0";
                    cell.style.textAlign = "right";
                    cell.id = key + "DropCount";

                    cell = row.insertCell(row.cells.length);
                    cell.innerText = "0.000 %";
                    cell.style.textAlign = "right";
                    cell.id = key + "DropPercent";

                }
            }

            function prepareSelectItem() {
                var sel = document.getElementById("selItem");

                var lootpoolCopy = lootpool.slice();

                lootpoolCopy.sort(function(a, b) {
                    if (a.name < b.name) {
                        return -1;
                    }
                    if (a.name > b.name) {
                        return 1;
                    }
                    return 0;
                });

                for (var i in lootpoolCopy) {
                    var option = document.createElement("option");
                    var e = lootpoolCopy[i];
                    option.text = e.name;
                    option.value = e.name;
                    sel.add(option);
                }

                sel.oninput = updateSelectedItemTables;

                document.getElementById("selCount").innerText = "" + lootpoolCopy.length;
            }

            function updateSelectedItemTables() {
                var sel = document.getElementById("selItem");

                var selItemTable = document.getElementById("selItemTable");

                for (var i = selItemTable.rows.length - 2; i >= 1; i--) {
                    selItemTable.deleteRow(i);
                }

                var sortByName = document.getElementById("selItemSortByName").checked;

                var fnSortByName = function(a, b) {
                                        if (a.key.length < b.key.length) {
                                            return -1;
                                        }
                                        if (a.key.length > b.key.length) {
                                            return 1;
                                        }
                                        for (var j = 0; j < a.key.length; j++) {
                                            if (a.key[j] < b.key[j]) {
                                                return -1;
                                            }
                                            if (a.key[j] > b.key[j]) {
                                                return 1;
                                            }
                                        }
                                        return 0;
                                    };

                if (sel.selectedIndex > 0) {
                    var opt = sel.options[sel.selectedIndex].value;

                    // itemName -> { count: int, category, stars: Map(int -> { count: int, effects: Map(prefix+major+minor -> count) })}
                    var item = setup.statItemMap.get(opt);

                    if (item != null) {
                        var insertIdx = 1;

                        for (var star = 0; star < 4; star++) {
                            var starInfo = item.stars.get(star);
                            if (starInfo != null) {

                                // group header
                                var tr0 = selItemTable.insertRow(insertIdx++);
                                tr0.style.fontWeight = "bolder";
                                var c0 = tr0.insertCell(0);
                                c0.colSpan = "3"

                                if (star == 0) {
                                    c0.innerText = "No stars";
                                } else {
                                    for (var k = 0; k < star; k++) {
                                        c0.innerText = c0.innerText + "\u2605";
                                    }
                                }
                                c0.style.textAlign = "center";

                                c0 = tr0.insertCell(1);
                                c0.innerText = "" + starInfo.count;
                                c0.style.textAlign = "right";

                                c0 = tr0.insertCell(2);
                                c0.innerText = "" + (starInfo.count * 100.0 / item.count).toFixed(3) + " %";
                                c0.style.textAlign = "right";

                                c0 = tr0.insertCell(3);
                                c0.innerText = "" + (starInfo.count * 100.0 / setup.progress).toFixed(3) + " %";
                                c0.style.textAlign = "right";


                                // items
                                var effects = [];
                                for (var [key, count] of starInfo.effects) {
                                    effects.push({ key: key.split(","), count: count });
                                }

                                if (sortByName) {
                                    effects.sort(fnSortByName);
                                } else {
                                    effects.sort(function(a, b) {
                                        if (a.count < b.count) {
                                            return 1;
                                        }
                                        if (a.count > b.count) {
                                            return -1;
                                        }
                                        return fnSortByName(a, b);
                                    });
                                }

                                for (var e in effects) {
                                    var eff = effects[e];

                                    var tr = selItemTable.insertRow(insertIdx++);

                                    for (var i = 0; i < 3; i++) {
                                        var c = tr.insertCell(i);
                                        if (eff.key.length > i) {
                                            c.innerText = eff.key[i];
                                            c.title = effectpoolLookup.get(item.category).get(i).get(eff.key[i]);
                                        } else {
                                            c.innerText = "-";
                                        }
                                    }

                                    var c = tr.insertCell(3);
                                    c.style.textAlign = "right";
                                    c.innerText = "" + eff.count;

                                    c = tr.insertCell(4);
                                    c.style.textAlign = "right";
                                    c.innerText = "" + (100.0 * eff.count / item.count).toFixed(3) + " %";

                                    c = tr.insertCell(5);
                                    c.style.textAlign = "right";
                                    c.innerText = "" + (100.0 * eff.count / setup.progress).toFixed(3) + " %";
                                }
                            }
                        }

                        document.getElementById("selItemTotal").innerText = "" + item.count;
                        document.getElementById("selItemTotalPercent").innerText = "" + (100.0 * item.count / setup.progress).toFixed(3) + " %";
                        return;
                    }
                }
                document.getElementById("selItemTotal").innerText = "0";
                document.getElementById("selItemTotalPercent").innerText = "0.000%";
            }


            prepareEffectStatsTable();
            prepareItemStatsTables();
            prepareSelectItem();

            document.getElementById("selItemSortByName").oninput = updateSelectedItemTables;
            document.getElementById("selItemSortByCount").oninput = updateSelectedItemTables;
        </script>
    </body>
</html>